---
title:  'MMP and the Weather'
author: "Facundo Danza & Eungik Lee"
subtitle: "Robustness: Historical period 1985-2005"
---

# Pre-analysis

First, we clean the R environment:
```{r}
rm(list = ls())
gc()
```

Then, we load the packages 
```{r}
if (!require("pacman")) install.packages("pacman")

pacman::p_load(tidyverse, data.table, janitor, dplyr, fixest, expss)
```

Define the `theme_set`
```{r}
theme_set(theme_bw())
```


Lastly, we set the directories in which we have the data:
```{r}
dir = list()
dir$root    <- dirname(getwd())
dir$data    <- paste0(dirname(getwd()), "/data/")
dir$weather    <- 
  paste0(dirname(getwd()), "/data/confidential/meteoblue/")
dir$results    <- paste0(dirname(getwd()), "/tables/robustness/")
dir$constructed_data    <- 
  paste0(dirname(getwd()), "/data/confidential/constructed/")
```


# Meteoblue - Weather Data

## Load the data

First, we load the daily weather data (and drop the missing values of it):
```{r}
weather_daily = read.csv(paste0(dir$weather, "weather.csv")) %>%
              filter(!is.na(day))
```

Since our data is annual rather than daily, we take the average (or sum) of each variable, Furthermore, we only keep the months from April to September, the wet season for Mexican crops:
```{r}
month_start = 4
month_end   = 9

weather_year = weather_daily %>% 
  filter(month >= month_start & month <= month_end) %>%
  group_by(commun, year, month) %>%
  summarise(prec_m_sum=sum(precipitation),
            across(starts_with("temp"), mean)) %>%
  group_by(commun, year) %>%
  summarise(prec_y_mean=mean(prec_m_sum),
            across(starts_with("temp"), 
                   mean, .names = "{.col}_y_mean"))
```


# Mexican Migration Project (MMP)

## Load the data
We first load the data on MMP. We have already clean the data - you can find the code as "mmp_data_analysis.Rmd."
```{r}
mmp = 
  read.csv(paste0(dir$constructed_data,"mmp_individual_clean.csv")) %>%
  filter(year >= 1989 &  pop_2010 <= 100000)
```


# Merge MMP and Weather

We, then, merge data on weather and MMP:
```{r}
mmp_com_weather = left_join(mmp, 
                            weather_year, by = c("commun","year")) %>%
  filter(!is.na(prec_y_mean))
```

Finally label some variables of interest:
```{r}
mmp_com_weather = mmp_com_weather %>%
  apply_labels(M_U   = "Migrant",
               M_UIL = "Illegal Migrant",
               M_UL  = "Legal Migrant",
               prec_y_mean = "Prec (Avg)",
               temp_avg_y_mean = "Temp (Avg)",
               temp_max_y_mean = "Max Temp (Avg)",
               temp_min_y_mean = "Min Temp (Avg)")
```


## Standarized Weather

First we need to "standarized" our weather data. That is, we find the historical average and standard deviation over the period 1985-2005:
```{r}
start_yr_hist = 1985
end_yr_hist   = 2005

weather_norm = weather_year %>%
  filter(year <= end_yr_hist & year >= start_yr_hist) %>%
  group_by(commun) %>%
  summarise(across(ends_with("y_mean"),
                   mean, .names = "{.col}_hist"), 
            across(ends_with("y_mean"),
                   sd, .names = "{.col}_sd_hist"))
```


We add this "normalized" dataset to the pre-existing one. Furthermoe, we only keep 10-year windows backward:
```{r}
year_window = 11
mmp_com_weather = left_join(mmp_com_weather, 
                            weather_norm, by = "commun")

mmp_com_weather = mmp_com_weather %>% 
  filter((surveyyr - year) <= year_window)
```


We then proceed by taking the z-score for each weather variable with respect to its:
```{r}
mmp_com_weather = 
  mmp_com_weather %>% 
  mutate(prec_y_mean_dev = 
           (prec_y_mean - prec_y_mean_hist)/prec_y_mean_sd_hist, 
         temp_avg_y_mean_dev = 
           (temp_avg_y_mean - temp_avg_y_mean_hist)/temp_avg_y_mean_sd_hist, 
         temp_max_y_mean_dev = 
           (temp_max_y_mean - temp_max_y_mean_hist)/temp_max_y_mean_sd_hist, 
         temp_min_y_mean_dev = 
           (temp_min_y_mean - temp_min_y_mean_hist)/temp_min_y_mean_sd_hist)
```

We also take the lag variables, which we believe is the relevant timing for the migration decision,
```{r}
mmp_com_weather = mmp_com_weather %>%
  arrange(id, year)

mmp_com_weather = mmp_com_weather %>%
  group_by(id) %>%
  mutate(prec_y_mean_dev_lag = lag(prec_y_mean_dev),
         across(starts_with("temp") & ends_with("y_mean_dev"), ~ lag(.x),
                .names = "{.col}_lag"))
```

# Regressions

## Baseline

```{r}
mmp_com_weather %>% ungroup() %>%
  summarise(prop_movers    = mean(M_U, na.rm = T), 
            prop_il_movers = mean(M_UIL, na.rm = T), 
            prop_l_movers  = mean(M_UL, na.rm = T))
```

## Regressions

We regress migration decision against the z-score of:

- Yearly (April-September) precipitations,
- Yearly (April-September) average temperature,
- Yearly (April-September) maximum temperature,
- Yearly (April-September) minimum temperature.

```{r}
formula = "M_U ~ prec_y_mean_dev_lag | id + year"
reg_list_imm = list(feols(as.formula(formula), 
      data = mmp_com_weather, se = 'cluster', cluster = "commun"))

for (i in c("temp_avg", "temp_max", "temp_min")) {
formula = paste0("M_U ~ ",i,"_y_mean_dev_lag | id + year")
  
reg_round = feols(as.formula(formula), 
      data = mmp_com_weather, se = 'cluster', cluster = "commun")

reg_list_imm = c(reg_list_imm, list(reg_round))
}
```

And we summaries all the results in the following table:
```{r}
setFixest_dict(c(M_U = "Migrant",
                 prec_y_mean_dev_lag     = "Dev Precipitation (Z-score, t-1)", 
                 temp_avg_y_mean_dev_lag = "Dev Avg Temp (Z-score, t-1)",
                 temp_max_y_mean_dev_lag = "Dev Max Temp (Z-score, t-1)",
                 temp_min_y_mean_dev_lag = "Dev Min Temp (Z-score, t-1)"))

etable(reg_list_imm[1:4],
         file = paste0(dir$results,"imm_1985-2005.txt"), 
       fitstat=c('n', 'ar2'),
       replace = TRUE)

etable(reg_list_imm[1:4])
```


## Illegal Migration

We do the same analysis but only for the illegal migrants:
```{r}
formula = "M_UIL ~ prec_y_mean_dev_lag | id + year"
reg_list_imm_il = list(feols(as.formula(formula), 
      data = mmp_com_weather, se = 'cluster', cluster = "commun"))

for (i in c("temp_avg", "temp_max", "temp_min")) {
formula = paste0("M_UIL ~ ",i,"_y_mean_dev_lag | id + year")
  
reg_round = feols(as.formula(formula), 
      data = mmp_com_weather, se = 'cluster', cluster = "commun")

reg_list_imm_il = c(reg_list_imm_il, list(reg_round))
}
```

And summaries the results:
```{r}
setFixest_dict(c(M_UIL = "Illegal Migrant",
                 prec_y_mean_dev_lag     = "Dev Precipitation (Z-score, t-1)", 
                 temp_avg_y_mean_dev_lag = "Dev Avg Temp (Z-score, t-1)",
                 temp_max_y_mean_dev_lag = "Dev Max Temp (Z-score, t-1)",
                 temp_min_y_mean_dev_lag = "Dev Min Temp (Z-score, t-1)"))

# etable(reg_list_imm_il[1:4], 
#        file = paste0(dir$results,"imm_il_1985-2005.txt"), 
#        fitstat=c('n', 'ar2'),
#        replace = TRUE)


etable(reg_list_imm_il[1:4])
```


## Legal Migrants

Lastly, we do the analysis for legal Migrants:
```{r}
formula = "M_UL ~ prec_y_mean_dev_lag | id + year"
reg_list_imm_l = list(feols(as.formula(formula), 
      data = mmp_com_weather, se = 'cluster', cluster = "commun"))

for (i in c("temp_avg", "temp_max", "temp_min")) {
formula = paste0("M_UL ~ ",i,"_y_mean_dev_lag | id + year")
  
reg_round = feols(as.formula(formula), 
      data = mmp_com_weather, se = 'cluster', cluster = "commun")

reg_list_imm_l = c(reg_list_imm_l, list(reg_round))
}
```

And summarise the result:
```{r}
setFixest_dict(c(M_UL = "Legal Migrant",
                 prec_y_mean_dev_lag     = "Dev Precipitation (Z-score, t-1)", 
                 temp_avg_y_mean_dev_lag = "Dev Avg Temp (Z-score, t-1)",
                 temp_max_y_mean_dev_lag = "Dev Max Temp (Z-score, t-1)",
                 temp_min_y_mean_dev_lag = "Dev Min Temp (Z-score, t-1)"))

# etable(reg_list_imm_l[1:4],
#        file = paste0(dir$results,"imm_l_1985-2005.txt"), 
#        fitstat=c('n', 'ar2'),
#        replace = TRUE)

etable(reg_list_imm_l[1:4])
```


```{r}
setFixest_dict(c(M_UL = "Legal Migrant", M_UIL = "Illegal Migrant",
                 prec_y_mean_dev_lag     = "Dev Precipitation (Z-score, t-1)", 
                 temp_avg_y_mean_dev_lag = "Dev Avg Temp (Z-score, t-1)",
                 temp_max_y_mean_dev_lag = "Dev Max Temp (Z-score, t-1)",
                 temp_min_y_mean_dev_lag = "Dev Min Temp (Z-score, t-1)")) 

etable(c(reg_list_imm_il[1:4],reg_list_imm_l[1:4]),
       file = paste0(dir$results,"imm_il_l_1985-2005.txt"),
       fitstat=c('n', 'ar2'), replace = TRUE)
```